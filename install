#!/usr/bin/env bash

set -e

function log() {
    echo -e "\033[34m=>\033[0m \033[1m$1\033[0m"
}

CONFIG="install.conf.yaml"
DOTBOT_DIR="dotbot"

DOTBOT_BIN="bin/dotbot"

if [ -n "${BASH_SOURCE[0]}" ]; then
    BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    log "Using existing dotfiles directory $BASEDIR"
else
    BASEDIR="$HOME/ghq/github.com/jarrodldavis/dotfiles"

    if [ -d "$BASEDIR" ]; then
        log "Using existing dotfiles directory $BASEDIR"
    else
        REPO="https://github.com/jarrodldavis/dotfiles.git"
        log "Cloning dotfiles repository $REPO to $BASEDIR"
        git clone "$REPO" "$BASEDIR"
    fi
fi

cd "${BASEDIR}"
git -C "${DOTBOT_DIR}" submodule sync --quiet --recursive
git submodule update --init --recursive "${DOTBOT_DIR}"

"${BASEDIR}/${DOTBOT_DIR}/${DOTBOT_BIN}" -d "${BASEDIR}" -c "${CONFIG}" --plugin-dir ./dotbot-plugins "${@}"
