#!/usr/bin/env bash

set -e

CONFIG="install/conf.yaml"
DOTBOT_DIR="dotbot"

DOTBOT_BIN="bin/dotbot"
BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/.."

cd "${BASEDIR}"

while ! xcode-select --print-path &> /dev/null; do
  xcode-select --install &> /dev/null
  echo 'Waiting for Xcode Command Line Developer Tools installation'
  echo '(Select "Install" in the "Install Command Line Developer Tools" prompt)'
  sleep 15
done

echo "Xcode or Xcode Command Line Developer Tools are installed at $(xcode-select --print-path)"

git submodule update --init --recursive

"${BASEDIR}/${DOTBOT_DIR}/${DOTBOT_BIN}" -d "${BASEDIR}" --plugin-dir dotbot-brew -c "${CONFIG}" "${@}"

# Replace current shell with Homebrew bash after interactive installation
if [[ -t 1 ]]; then
  exec bash -l
fi
