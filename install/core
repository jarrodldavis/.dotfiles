#!/usr/bin/env bash

set -e

CONFIG="install/conf.yaml"
DOTBOT_DIR="dotbot"

DOTBOT_BIN="bin/dotbot"
BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/.."

cd "${BASEDIR}"

while ! xcode-select --print-path &> /dev/null; do
  xcode-select --install &> /dev/null
  echo 'Waiting for Xcode Command Line Developer Tools installation'
  echo '(Select "Install" in the "Install Command Line Developer Tools" prompt)'
  sleep 15
done

echo "Xcode or Xcode Command Line Developer Tools are installed at $(xcode-select --print-path)"

git submodule update --init --recursive

"${BASEDIR}/${DOTBOT_DIR}/${DOTBOT_BIN}" -d "${BASEDIR}" --plugin-dir dotbot-brew -c "${CONFIG}" "${@}"

# Check for updated bash
if [[ "$SHELL" != "$(command -v bash)" ]]; then
  echo "A new installation of bash was installed via Homebrew. Be sure to exit this interactive shell process to use it."
elif [[ "$BASH_VERSION" != "$(bash -c 'echo $BASH_VERSION')" ]]; then
  echo "A new version of bash was updated via Homebrew. Be sure to exit this interactive shell process to use it."
fi
